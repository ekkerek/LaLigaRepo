# Stage 1: Build the application
FROM mcr.microsoft.com/dotnet/sdk:7.0 AS build
WORKDIR /src
COPY LA_LIGA_REKREATIVO/ .

# Restore dependencies
RUN dotnet restore "Client/LA_LIGA_REKREATIVO.Client.csproj"

# Build the application
COPY . .
RUN dotnet build "Client/LA_LIGA_REKREATIVO.Client.csproj" -c Release -o /app/build

# Stage 2: Publish the application
FROM build AS publish
RUN dotnet publish "Client/LA_LIGA_REKREATIVO.Client.csproj" -c Release -o /app/publish

# Stage 3: Final stage - Use Nginx to serve the Blazor client
FROM nginxinc/nginx-unprivileged:bookworm-perl AS final
WORKDIR /usr/share/nginx/html

# Copy the Blazor app's published files from the 'publish' stage
COPY --from=publish /app/publish/wwwroot .

# Copy custom Nginx configuration if needed
COPY nginx.conf /etc/nginx/nginx.conf

RUN sudo apt update
RUN sudo apt install certbot
RUN sudo certbot certonly --standalone -d laligarekreativo.com -d www.laligarekreativo.com

# Expose HTTP and HTTPS ports
EXPOSE 80
EXPOSE 443

# Set the user to root (this is needed to run Nginx in some environments)
USER root